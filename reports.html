<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Pharmacy Inventory System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, #a8d8ff 0%, #b8e6e6 100%);
        }

        .bg-animation span {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            animation: float 25s infinite;
            border-radius: 50%;
        }

        .bg-animation span:nth-child(1) {
            left: 25%;
            animation-delay: 0s;
            width: 80px;
            height: 80px;
        }

        .bg-animation span:nth-child(2) {
            left: 10%;
            animation-delay: 2s;
            width: 20px;
            height: 20px;
        }

        .bg-animation span:nth-child(3) {
            left: 70%;
            animation-delay: 4s;
            width: 40px;
            height: 40px;
        }

        .bg-animation span:nth-child(4) {
            left: 40%;
            animation-delay: 0s;
            width: 60px;
            height: 60px;
        }

        .bg-animation span:nth-child(5) {
            left: 65%;
            animation-delay: 0s;
            width: 30px;
            height: 30px;
        }

        .bg-animation span:nth-child(6) {
            left: 75%;
            animation-delay: 3s;
            width: 50px;
            height: 50px;
        }

        .bg-animation span:nth-child(7) {
            left: 35%;
            animation-delay: 7s;
            width: 45px;
            height: 45px;
        }

        .bg-animation span:nth-child(8) {
            left: 50%;
            animation-delay: 15s;
            width: 25px;
            height: 25px;
        }

        .bg-animation span:nth-child(9) {
            left: 20%;
            animation-delay: 2s;
            width: 35px;
            height: 35px;
        }

        .bg-animation span:nth-child(10) {
            left: 85%;
            animation-delay: 0s;
            width: 55px;
            height: 55px;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* All content should be above the animation */
        .navbar,
        .container,
        .footer {
            position: relative;
            z-index: 10;
        }

        /* Navigation Bar */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
        }

        .nav-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .nav-brand h2 {
            font-size: 22px;
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 5px;
            flex: 1;
            justify-content: center;
        }

        .nav-menu li a {
            text-decoration: none;
            color: #666;
            padding: 25px 20px;
            display: block;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-menu li a:hover {
            color: #0093E9;
            background: rgba(0, 147, 233, 0.05);
        }

        .nav-menu li a.active {
            color: #0093E9;
            border-bottom-color: #0093E9;
            background: rgba(0, 147, 233, 0.05);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-user span {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-logout {
            padding: 8px 20px;
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 147, 233, 0.3);
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 147, 233, 0.4);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 32px;
            color: #333;
            font-weight: 600;
        }

        /* Report Navigation */
        .report-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 20px;
            border: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #555;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 147, 233, 0.3);
        }

        /* Sub Navigation */
        .sub-nav {
            display: flex;
            gap: 8px;
            margin: 15px 0 25px;
            flex-wrap: wrap;
        }

        .sub-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
        }

        .sub-btn:hover {
            border-color: #0093E9;
            color: #0093E9;
        }

        .sub-btn.active {
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
            border-color: transparent;
        }

        .report-section {
            display: none;
        }

        .report-section.active {
            display: block;
        }

        .sub-content {
            display: none;
        }

        .sub-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Section Header */
        .section-header {
            margin-bottom: 15px;
            border-bottom: 3px solid;
            border-image: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%) 1;
            padding-bottom: 10px;
            font-size: 24px;
            color: #333;
            font-weight: 600;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn-success {
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-info {
            padding: 10px 20px;
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 147, 233, 0.3);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 147, 233, 0.4);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .stat-icon {
            font-size: 48px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .stat-info h3 {
            font-size: 28px;
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-weight: 700;
        }

        .stat-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        /* Chart Section */
        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .chart-header h3 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
            margin: 0;
        }

        .chart-container {
            position: relative;
            height: 360px;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .chart-type-btn {
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #e5e7eb;
            background: white;
            font-size: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
        }

        .chart-type-btn:hover {
            border-color: #0093E9;
            color: #0093E9;
        }

        .chart-type-btn.active {
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
            border-color: transparent;
        }

        /* Table Section */
        .table-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .table-section h3 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
        }

        .data-table thead th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s;
        }

        .data-table tbody tr:hover {
            background: rgba(0, 147, 233, 0.05);
            transform: scale(1.01);
        }

        .data-table tbody td {
            padding: 15px;
            font-size: 14px;
            color: #666;
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tbody tr:nth-child(even):hover {
            background: rgba(0, 147, 233, 0.05);
        }

        /* Badges */
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-info {
            background: linear-gradient(135deg, rgba(0, 147, 233, 0.15), rgba(128, 208, 199, 0.15));
            color: #0093E9;
            border: 1px solid rgba(0, 147, 233, 0.3);
        }

        .badge-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Text Colors */
        .amount {
            color: #10b981;
            font-weight: 600;
        }

        .highlight {
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .danger {
            color: #ef4444;
            font-weight: 600;
        }

        /* Row Colors */
        .warning-row {
            background: rgba(245, 158, 11, 0.03);
        }

        .warning-row:hover {
            background: rgba(245, 158, 11, 0.08);
        }

        .danger-row {
            background: rgba(239, 68, 68, 0.03);
        }

        .danger-row:hover {
            background: rgba(239, 68, 68, 0.08);
        }

        /* Rank Badge */
        .rank {
            display: inline-block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
            color: white;
            text-align: center;
            line-height: 32px;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 147, 233, 0.3);
        }

        /* Empty State */
        .empty-box {
            background: white;
            padding: 60px 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            color: #999;
            font-size: 16px;
        }

        .empty-box::before {
            content: "üì≠";
            display: block;
            font-size: 64px;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Footer */
        .footer {
            background: white;
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 40px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .nav-menu li a {
                padding: 25px 15px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-menu li a {
                padding: 15px 12px;
            }

            .container {
                padding: 20px;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .table-container {
                overflow-x: auto;
            }

            .data-table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="nav-logo">
                <h2>Saravana Medicals</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('medicines') }}">Medicines</a></li>
                <li><a href="{{ url_for('stock') }}">Stock</a></li>
                <li><a href="{{ url_for('expiry') }}">Expiry Alert</a></li>
                <li><a href="{{ url_for('billing') }}">Billing</a></li>
                <li><a href="{{ url_for('suppliers_advanced') }}">Suppliers</a></li>
                <li><a href="{{ url_for('reports') }}" class="active">Reports</a></li>
            </ul>
            <div class="nav-user">
                <span>Welcome, {{ session.username }}</span>
                <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Reports & Analytics</h1>
        </div>

        <!-- Main Navigation -->
        <div class="report-nav">
            <button class="nav-btn active" onclick="showSection('sales', event)">üí∞ Sales Summary</button>
            <button class="nav-btn" onclick="showSection('stock', event)">üì¶ Stock Reports</button>
            <button class="nav-btn" onclick="showSection('expiry', event)">‚è∞ Expiry Reports</button>
            <button class="nav-btn" onclick="showSection('supplier', event)">üè¢ Supplier Reports</button>
        </div>

        <!-- ================= SALES SUMMARY ================= -->
        <div id="salesSection" class="report-section active">
            <h2 class="section-header">Sales Summary</h2>
            
            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="btn-success" onclick="exportSectionPDF('salesSection')">üìÑ Export PDF</button>
                <button class="btn-info" onclick="exportSectionExcel('salesSection')">üìó Export Excel</button>
            </div>

            <div class="sub-nav">
                <button class="sub-btn active" onclick="showSub('sales','today',event)">Today Sales</button>
                <button class="sub-btn" onclick="showSub('sales','monthly',event)">Monthly Sales</button>
                <button class="sub-btn" onclick="showSub('sales','top',event)">Top Selling</button>
                <button class="sub-btn" onclick="showSub('sales','least',event)">Least Selling</button>
            </div>

            <!-- Today Sales -->
            <div id="sales-today" class="sub-content active">
                {% set today_total = today_sales|sum(attribute='total_amount') if today_sales else 0 %}
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <h3>‚Çπ{{ "%.2f"|format(today_total) }}</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üßæ</div>
                        <div class="stat-info">
                            <h3>{{ today_sales|length if today_sales else 0 }}</h3>
                            <p>Total Bills</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-info">
                            <h3>{{ today_sales|sum(attribute='items_count') if today_sales else 0 }}</h3>
                            <p>Items Sold</p>
                        </div>
                    </div>
                </div>

                {% if today_sales %}
                <div class="chart-section">
                    <div class="chart-header">
                        <h3>Payment Method wise Revenue</h3>
                        <div class="chart-controls">
                            <span class="control-label">View as:</span>
                            <button class="chart-type-btn active" onclick="changeChartType('today','bar',event)">Bar</button>
                            <button class="chart-type-btn" onclick="changeChartType('today','pie',event)">Pie</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="todayChart"></canvas>
                    </div>
                </div>

                <div class="table-section">
                    <h3>Today Transactions</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Sale ID</th>
                                    <th>Time</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in today_sales %}
                                <tr>
                                    <td>#{{ s.sale_id }}</td>
                                    <td>{{ s.sale_date }}</td>
                                    <td>{{ s.customer_name or 'Walk-in' }}</td>
                                    <td>{{ s.items_count }}</td>
                                    <td class="amount">‚Çπ{{ "%.2f"|format(s.total_amount) }}</td>
                                    <td><span class="badge badge-info">{{ s.payment_method }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No sales today.</div>
                {% endif %}
            </div>

            <!-- Monthly Sales -->
            <div id="sales-monthly" class="sub-content">
                {% set month_total = monthly_sales|sum(attribute='total_amount') if monthly_sales else 0 %}
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-info">
                            <h3>‚Çπ{{ "%.2f"|format(month_total) }}</h3>
                            <p>Monthly Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <h3>{{ monthly_sales|length if monthly_sales else 0 }}</h3>
                            <p>Total Transactions</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-info">
                            <h3>‚Çπ{{ "%.2f"|format((month_total / monthly_sales|length) if monthly_sales else 0) }}</h3>
                            <p>Average Bill</p>
                        </div>
                    </div>
                </div>

                {% if monthly_sales %}
                <div class="chart-section">
                    <div class="chart-header">
                        <h3>Daily Revenue (Current Month)</h3>
                        <div class="chart-controls">
                            <span class="control-label">View as:</span>
                            <button class="chart-type-btn active" onclick="changeChartType('monthly','bar',event)">Bar</button>
                            <button class="chart-type-btn" onclick="changeChartType('monthly','line',event)">Line</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <div class="table-section">
                    <h3>All Transactions This Month</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Sale ID</th>
                                    <th>Date & Time</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in monthly_sales %}
                                <tr>
                                    <td>#{{ s.sale_id }}</td>
                                    <td>{{ s.sale_date }}</td>
                                    <td>{{ s.customer_name or 'Walk-in Customer' }}</td>
                                    <td>{{ s.items_count }}</td>
                                    <td class="amount">‚Çπ{{ "%.2f"|format(s.total_amount) }}</td>
                                    <td><span class="badge badge-success">{{ s.payment_method }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No monthly sales data.</div>
                {% endif %}
            </div>

            <!-- Top Selling -->
            <div id="sales-top" class="sub-content">
                <h3 style="margin-bottom: 20px;">üèÜ Top Selling Medicines</h3>
                {% if top_medicines %}
                <div class="chart-section">
                    <div class="chart-container">
                        <canvas id="topChart"></canvas>
                    </div>
                </div>
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Medicine</th>
                                    <th>Category</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in top_medicines %}
                                <tr>
                                    <td><span class="rank">{{ loop.index }}</span></td>
                                    <td>{{ m.medicine_name }}</td>
                                    <td>{{ m.category }}</td>
                                    <td class="highlight">{{ m.total_sold }}</td>
                                    <td class="amount">‚Çπ{{ "%.2f"|format(m.total_revenue) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No sales data.</div>
                {% endif %}
            </div>

            <!-- Least Selling -->
            <div id="sales-least" class="sub-content">
                <h3 style="margin-bottom: 20px;">üìâ Least Selling Medicines</h3>
                {% if least_medicines %}
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Medicine</th>
                                    <th>Category</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in least_medicines %}
                                <tr>
                                    <td>{{ m.medicine_name }}</td>
                                    <td>{{ m.category }}</td>
                                    <td class="warning">{{ m.total_sold }}</td>
                                    <td>‚Çπ{{ "%.2f"|format(m.total_revenue) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No data.</div>
                {% endif %}
            </div>
        </div>

        <!-- ================= STOCK REPORTS ================= -->
        <div id="stockSection" class="report-section">
            <h2 class="section-header">üì¶ Stock Reports</h2>
            
            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="btn-success" onclick="exportSectionPDF('stockSection')">üìÑ Export PDF</button>
                <button class="btn-info" onclick="exportSectionExcel('stockSection')">üìó Export Excel</button>
            </div>

            <div class="sub-nav">
                <button class="sub-btn active" onclick="showSub('stock','low',event)">Low Stock</button>
                <button class="sub-btn" onclick="showSub('stock','out',event)">Out of Stock</button>
                <button class="sub-btn" onclick="showSub('stock','value',event)">Stock Total Value</button>
            </div>

            <!-- Low Stock -->
            <div id="stock-low" class="sub-content active">
                <h3 style="margin-bottom: 20px;">‚ö†Ô∏è Low Stock (qty < 10)</h3>
                {% if low_stock %}
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Medicine</th>
                                    <th>Batch</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Supplier</th>
                                    <th>Expiry</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in low_stock %}
                                <tr class="warning-row">
                                    <td>{{ m.medicine_name }}</td>
                                    <td>{{ m.batch_number }}</td>
                                    <td class="warning">{{ m.quantity }}</td>
                                    <td>‚Çπ{{ "%.2f"|format(m.price) }}</td>
                                    <td>{{ m.supplier_name or 'N/A' }}</td>
                                    <td>{{ m.expiry_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">All items well stocked.</div>
                {% endif %}
            </div>

            <!-- Out of Stock -->
            <div id="stock-out" class="sub-content">
                <h3 style="margin-bottom: 20px;">üö´ Out of Stock</h3>
                {% if out_stock %}
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Medicine</th>
                                    <th>Category</th>
                                    <th>Batch</th>
                                    <th>Price</th>
                                    <th>Supplier</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in out_stock %}
                                <tr class="danger-row">
                                    <td>{{ m.medicine_name }}</td>
                                    <td>{{ m.category }}</td>
                                    <td>{{ m.batch_number }}</td>
                                    <td>‚Çπ{{ "%.2f"|format(m.price) }}</td>
                                    <td>{{ m.supplier_name or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No out of stock items.</div>
                {% endif %}
            </div>

            <!-- Stock Value -->
            <div id="stock-value" class="sub-content">
                <h3 style="margin-bottom: 20px;">üíé Stock Total Value</h3>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <h3>‚Çπ{{ "%.2f"|format(stock_value.total_value if stock_value else 0) }}</h3>
                            <p>Total Inventory Value</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíä</div>
                        <div class="stat-info">
                            <h3>{{ stock_value.total_medicines if stock_value else 0 }}</h3>
                            <p>Medicine Types</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-info">
                            <h3>{{ stock_value.total_quantity if stock_value else 0 }}</h3>
                            <p>Total Units</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= EXPIRY REPORTS ================= -->
        <div id="expirySection" class="report-section">
            <h2 class="section-header">‚è∞ Expiry Reports</h2>
            
            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="btn-success" onclick="exportSectionPDF('expirySection')">üìÑ Export PDF</button>
                <button class="btn-info" onclick="exportSectionExcel('expirySection')">üìó Export Excel</button>
            </div>

            <div class="sub-nav">
                <button class="sub-btn active" onclick="showSub('expiry','expired',event)">Expired Items</button>
                <button class="sub-btn" onclick="showSub('expiry','near',event)">Near Expiry ‚Äì 30 Days</button>
            </div>

            <!-- Expired -->
            <div id="expiry-expired" class="sub-content active">
                <h3 style="margin-bottom: 20px;">üö´ Expired Medicines</h3>
                {% if expired %}
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Medicine</th>
                                    <th>Batch</th>
                                    <th>Qty</th>
                                    <th>Expiry</th>
                                    <th>Supplier</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in expired %}
                                <tr class="danger-row">
                                    <td>{{ m.medicine_name }}</td>
                                    <td>{{ m.batch_number }}</td>
                                    <td>{{ m.quantity }}</td>
                                    <td class="danger">{{ m.expiry_date }}</td>
                                    <td>{{ m.supplier_name or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No expired items.</div>
                {% endif %}
            </div>

            <!-- Near Expiry -->
            <div id="expiry-near" class="sub-content">
                <h3 style="margin-bottom: 20px;">üìÖ Expiring Within 30 Days</h3>
                {% if near_expiry %}
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Medicine</th>
                                    <th>Batch</th>
                                    <th>Qty</th>
                                    <th>Expiry</th>
                                    <th>Supplier</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in near_expiry %}
                                <tr class="warning-row">
                                    <td>{{ m.medicine_name }}</td>
                                    <td>{{ m.batch_number }}</td>
                                    <td>{{ m.quantity }}</td>
                                    <td class="warning">{{ m.expiry_date }}</td>
                                    <td>{{ m.supplier_name or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No items expiring soon.</div>
                {% endif %}
            </div>
        </div>

        <!-- ================= SUPPLIER REPORTS ================= -->
        <div id="supplierSection" class="report-section">
            <h2 class="section-header">üè¢ Supplier Reports</h2>
            
            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="btn-success" onclick="exportSectionPDF('supplierSection')">üìÑ Export PDF</button>
                <button class="btn-info" onclick="exportSectionExcel('supplierSection')">üìó Export Excel</button>
            </div>

            <div class="sub-nav">
                <button class="sub-btn active" onclick="showSub('supplier','sales',event)">Supplier‚ÄëWise Sale</button>
                <button class="sub-btn" onclick="showSub('supplier','purchase',event)">Purchase Summary</button>
            </div>

            <!-- Supplier Wise Sale -->
            <div id="supplier-sales" class="sub-content active">
                <h3 style="margin-bottom: 20px;">üìä Supplier-Wise Sales</h3>
                {% if supplier_sales %}
                <div class="chart-section">
                    <div class="chart-container">
                        <canvas id="supplierChart"></canvas>
                    </div>
                </div>
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Supplier</th>
                                    <th>Total Sales</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in supplier_sales %}
                                <tr>
                                    <td><span class="rank">{{ loop.index }}</span></td>
                                    <td>{{ s.supplier_name }}</td>
                                    <td>{{ s.total_sales }}</td>
                                    <td class="highlight">{{ s.total_quantity }}</td>
                                    <td class="amount">‚Çπ{{ "%.2f"|format(s.total_revenue) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No supplier sales data.</div>
                {% endif %}
            </div>

            <!-- Purchase Summary -->
            <div id="supplier-purchase" class="sub-content">
                <h3 style="margin-bottom: 20px;">üßæ Purchase Summary</h3>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3>{{ supplier_sales|length if supplier_sales else 0 }}</h3>
                            <p>Active Suppliers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíä</div>
                        <div class="stat-info">
                            <h3>{{ medicines|length if medicines else 0 }}</h3>
                            <p>Medicines Stocked</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-info">
                            <h3>{{ stock_value.total_quantity if stock_value else 0 }}</h3>
                            <p>Total Units in Stock</p>
                        </div>
                    </div>
                </div>

                {% if supplier_sales %}
                <div class="table-section">
                    <h3>Supplier-Wise Purchase History</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th>Medicines Supplied</th>
                                    <th>Total Units Purchased</th>
                                    <th>Revenue Generated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in supplier_sales %}
                                <tr>
                                    <td>{{ s.supplier_name }}</td>
                                    <td>{{ s.total_sales }}</td>
                                    <td class="highlight">{{ s.total_quantity }}</td>
                                    <td class="amount">‚Çπ{{ "%.2f"|format(s.total_revenue) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-box">No purchase history available.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; Saravana Medicals. All rights reserved.</p>
    </footer>

    <!-- Chart.js and Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let todayChart = null;
        let monthlyChart = null;
        let topChart = null;
        let supplierChart = null;

        // Section Navigation
        function showSection(key, ev) {
            document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(key + 'Section').classList.add('active');
            if (ev) ev.currentTarget.classList.add('active');
        }

        // Sub Navigation
        function showSub(parent, sub, ev) {
            const sec = document.getElementById(parent + 'Section');
            sec.querySelectorAll('.sub-content').forEach(s => s.classList.remove('active'));
            sec.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(parent + '-' + sub).classList.add('active');
            if (ev) ev.currentTarget.classList.add('active');
        }

        // Change Chart Type
        function changeChartType(which, type, ev) {
            const chart = (which === 'today') ? todayChart : monthlyChart;
            if (!chart) return;
            chart.config.type = type;
            chart.update();
            const container = document.getElementById(which === 'today' ? 'sales-today' : 'sales-monthly');
            container.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
            if (ev) ev.currentTarget.classList.add('active');
        }

        // FIXED Export PDF Function - Works for all sections
        function exportSectionPDF(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                alert('Section not found');
                return;
            }

            // Find active sub-content or first table in section
            let table = section.querySelector('.sub-content.active .data-table');
            if (!table) {
                table = section.querySelector('.data-table');
            }

            if (!table) {
                alert('No data table found in this section');
                return;
            }

            const sectionTitles = {
                'salesSection': 'Sales Summary Report',
                'stockSection': 'Stock Report',
                'expirySection': 'Expiry Report',
                'supplierSection': 'Supplier Report'
            };
            const title = sectionTitles[sectionId] || 'Pharmacy Report';

            html2canvas(table, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 280;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.setFontSize(16);
                pdf.text(title, 14, 15);
                pdf.addImage(imgData, 'PNG', 10, 25, imgWidth, imgHeight);
                pdf.save(`${sectionId}_${new Date().toISOString().split('T')[0]}.pdf`);
            });
        }

        // FIXED Export Excel Function - Works for all sections
        function exportSectionExcel(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                alert('Section not found');
                return;
            }

            // Find active sub-content or first table in section
            let table = section.querySelector('.sub-content.active .data-table');
            if (!table) {
                table = section.querySelector('.data-table');
            }

            if (!table) {
                alert('No data table found in this section');
                return;
            }

            const rows = table.querySelectorAll('tr');
            const data = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td, th');
                data.push(Array.from(cells).map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','));
            });

            const csv = data.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${sectionId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Initialize Charts
        document.addEventListener('DOMContentLoaded', function() {
            const todayData = {{ today_sales|tojson|safe }};
            const monthlyData = {{ monthly_sales|tojson|safe }};
            const topMeds = {{ top_medicines|tojson|safe }};
            const supplierData = {{ supplier_sales|tojson|safe }};

            const gradientBlue = function(ctx) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(0, 147, 233, 0.8)');
                gradient.addColorStop(1, 'rgba(128, 208, 199, 0.8)');
                return gradient;
            };

            // Today Chart
            if (todayData.length && document.getElementById('todayChart')) {
                const totals = {};
                todayData.forEach(s => {
                    const m = s.payment_method || 'Other';
                    totals[m] = (totals[m] || 0) + s.total_amount;
                });
                const labels = Object.keys(totals);
                const values = labels.map(k => totals[k]);

                const ctx = document.getElementById('todayChart').getContext('2d');
                todayChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue (‚Çπ)',
                            data: values,
                            backgroundColor: gradientBlue(ctx),
                            borderColor: '#0093E9',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    font: {
                                        family: 'Poppins',
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        family: 'Poppins'
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Poppins'
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Monthly Chart
            if (monthlyData.length && document.getElementById('monthlyChart')) {
                const totals = {};
                monthlyData.forEach(s => {
                    const d = s.sale_date.split(' ')[0];
                    totals[d] = (totals[d] || 0) + s.total_amount;
                });
                const labels = Object.keys(totals).sort();
                const values = labels.map(k => totals[k]);

                const ctx = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Revenue (‚Çπ)',
                            data: values,
                            backgroundColor: gradientBlue(ctx),
                            borderColor: '#0093E9',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    font: {
                                        family: 'Poppins',
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        family: 'Poppins'
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Poppins'
                                    }
                                }
                                }
                            }
                        }
                    });
                }

                // Top Selling Chart
                if (topMeds.length && document.getElementById('topChart')) {
                    const labels = topMeds.map(m => m.medicine_name);
                    const values = topMeds.map(m => m.total_sold);

                    const ctx = document.getElementById('topChart').getContext('2d');
                    topChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Units Sold',
                                data: values,
                                backgroundColor: gradientBlue(ctx),
                                borderColor: '#0093E9',
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        font: {
                                            family: 'Poppins',
                                            size: 12
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Poppins'
                                        }
                                    }
                                },
                                y: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Poppins'
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Supplier Chart
                if (supplierData.length && document.getElementById('supplierChart')) {
                    const labels = supplierData.map(s => s.supplier_name);
                    const values = supplierData.map(s => s.total_revenue);

                    const ctx = document.getElementById('supplierChart').getContext('2d');
                    supplierChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Revenue (‚Çπ)',
                                data: values,
                                backgroundColor: gradientBlue(ctx),
                                borderColor: '#0093E9',
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        font: {
                                            family: 'Poppins',
                                            size: 12
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Poppins'
                                        }
                                    }
                                },
                                y: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Poppins'
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            });
    </script>
</body>
</html>